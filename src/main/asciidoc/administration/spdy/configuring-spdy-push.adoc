//  ========================================================================
//  Copyright (c) 1995-2016 Mort Bay Consulting Pty. Ltd.
//  ========================================================================
//  All rights reserved. This program and the accompanying materials
//  are made available under the terms of the Eclipse Public License v1.0
//  and Apache License v2.0 which accompanies this distribution.
//
//      The Eclipse Public License is available at
//      http://www.eclipse.org/legal/epl-v10.html
//
//      The Apache License v2.0 is available at
//      http://www.opensource.org/licenses/apache2.0.php
//
//  You may elect to redistribute this code under either of these licenses.
//  ========================================================================

[[spdy-configuring-push]]
= Configuring SPDY push

http://www.chromium.org/spdy/spdy-protocol/spdy-protocol-draft3#TOC-3.3-Server-Push-Transactions[SPDY
push] allows the server to send multiple resources to the client for a
single client request. This will reduce the amount of round-trips and
can significantly improve page load times. A full page load from germany
to https://www.webtide.com via SPDY and without push takes ~3s. The same
request with push enabled takes only ~1s.

To enable push in Jetty the SPDY connector needs to be configured with
an implementation
oflink:{JDURL}/org/eclipse/jetty/spdy/server/http/PushStrategy.html[PushStrategy].
For each request Jetty will call the
link:{JDURL}/org/eclipse/jetty/spdy/server/http/PushStrategy
      .html[PushStrategy's] apply method which will return a Set with
the resources to push.

== ReferrerPushStrategy

The
link:{JDURL}/org/eclipse/jetty/spdy/server/http/ReferrerPushStrategy.html[ReferrerPushStrategy]
is a
link:{JDURL}/org/eclipse/jetty/spdy/server/http/PushStrategy.html[PushStrategy]
implementation that will use the HTTP "referer" header to identify if a
resource belongs to a main resource.

A step by step example of how this works:

* client requests index.html
* client parses index.html and requests style.css, image1.png and
image2.png setting the referer header to index.html for these requests.
* link:{JDURL}/org/eclipse/jetty/spdy/server/http/ReferrerPushStrategy.html[ReferrerPushStrategy]
will use this information to associate the subresources to index .html
* The next request to index.html from another client will get all
subresources pushed without further requests

This will also work for nested subresources. E.g. a pushed style.css
might initiate further resource pushes for subresources referred to by
the style.css stylesheet.

___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
*Note*

*The referrerPushPeriod setting will define the time that
link:{JDURL}/org/eclipse/jetty/spdy/server/http/ReferrerPushStrategy.html[ReferrerPushStrategy]
will record subresources after the initial request. If this period has
elapsed no further subresources will be recorded.*
___________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________

== Configuring ReferrerPushStrategy

In the Jetty `etc` directory you will find jetty-spdy.xml file which can
be modified to suit your needs. It contains a commented
link:{JDURL}/org/eclipse/jetty/spdy/server/http/ReferrerPushStrategy.html[ReferrerPushStrategy]
configuration.

An example
link:{JDURL}/org/eclipse/jetty/spdy/server/http/ReferrerPushStrategy.html[ReferrerPushStrategy]
configuration can look as follows:

[source,xml]
----
                
  <!-- =========================================================== -->
  <!-- Create a push strategy which can be used by reference by    -->
  <!-- individual connection factories below.                      -->
  <!--                                                             -->
  <!-- Consult the javadoc of o.e.j.spdy.server.http.ReferrerPushStrategy -->
  <!-- for all configuration that may be set here.                 -->
  <!-- =========================================================== -->
  <New id="pushStrategy" class="org.eclipse.jetty.spdy.server.http.ReferrerPushStrategy">
    <!-- Uncomment to blacklist browsers for this push strategy. If one of the blacklisted Strings occurs in the
         user-agent header sent by the client, push will be disabled for this browser. This is case insensitive" -->
    <!--
    <Set name="UserAgentBlacklist">
        <Array type="String">
            <Item>.*(?i)firefox/14.*</Item>
            <Item>.*(?i)firefox/15.*</Item>
            <Item>.*(?i)firefox/16.*</Item>
        </Array>
    </Set>
    -->

    <!-- Uncomment to override default file extensions to push -->
    <!--
    <Set name="PushRegexps">
        <Array type="String">
           <Item>.*\.css</Item>
           <Item>.*\.js</Item>
           <Item>.*\.png</Item>
           <Item>.*\.jpg</Item>
           <Item>.*\.gif</Item>
       </Array>
    </Set>
    -->
    <Set name="referrerPushPeriod">5000</Set>
    <Set name="maxAssociatedResources">32</Set>
  </New>

            
----

Note the commented parts that let you restrict the User-Agents and file
extensions.

Important Options:

referrerPushPeriod::
  If referrerPushPeriod has elapsed after the initial request to a
  mainresource, no more subresources will be added to the push cache.
maxAssociatedResources::
  The maximum amount of subresources being pushed for a single main
  resource.

Then you have to add the configured
link:{JDURL}/org/eclipse/jetty/spdy/server/http/ReferrerPushStrategy.html[ReferrerPushStrategy]
to the connection factory as follows.

_______________________________________________________________________________________
*Note*

*In the default config provided with Jetty the pushStrategy argument is
commented out!*
_______________________________________________________________________________________

[source,xml]
----
                
            <!-- SPDY/3 Connection factory -->
            <Item>
              <New class="org.eclipse.jetty.spdy.server.http.HTTPSPDYServerConnectionFactory">
                <Arg name="version" type="int">3</Arg>
                <Arg name="config"><Ref refid="sslHttpConfig" /></Arg>
                <Arg name="pushStrategy"><Ref refid="pushStrategy"/></Arg>
              </New>
            </Item>

            
----

See the javadocs for link:{JDURL}/org/eclipse/jetty/spdy/server/http/ReferrerPushStrategy.html[ReferrerPushStrategy] and sources for further details if needed.

____
[NOTE]
*Visit https://www.webtide.com with a browser that supports push (e.g. a recent chrome browser) to see it in action.*
____

== Try it!

To verify if your setup works fine you can use chrome and it's very
useful chrome://net-internals/#spdy page. Open that page in a tab of
your browser. Then make sure you load a main resource of your
application to fill the push cache. Then reload the page bypassing the
browser's cache (STRG+SHIFT+R or CMD+SHIFT+R on OSX).

Chrome's net-internals page should tell you how many resources have been
pushed and actually pushed and claimed (actually needed and used by the
browser)

image:images/chrome_net_internals.png[image]

Another option is to enable debug logging for ReferrerPushStrategy or
org.eclipse.jetty.spdy. Have a look at the
xref:configuring-logging[] for details.
